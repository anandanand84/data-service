var PubSub=function(){function c(){this.topics={};this.subUid=-1;if(c._instance)throw Error("Error: Instantiation failed: Use PubSub.getInstance() instead of new.");}c.getInstance=function(){null===c._instance&&(c._instance=new c);return c._instance};c.prototype.publish=function(d,b){if(!this.topics[d])return!1;for(var a=this.topics[d],e=a?a.length:0;e--;)a[e].func(d,b);return!0};c.prototype.subscribe=function(d,b){this.topics[d]||(this.topics[d]=[]);var a=(++this.subUid).toString();this.topics[d].push({token:a,
func:b});return a};c.prototype.unsubscribe=function(d){for(var b in this.topics)if(this.topics[b]){for(var a=0,e=this.topics[b].length;a<e;a++)if(this.topics[b][a].token===d)return this.topics[b].splice(a,1),!0;0==this.topics[b].length&&delete this.topics[b]}return!1};c._instance=null;return c}(),isNode=isNode||!1;
if(!isNode){var dcodeIO=dcodeIO||{};if("undefined"===typeof dcodeIO||!dcodeIO.ProtoBuf)throw Error("ProtoBuf.js is not present. Please see www/index.html for manual setup instructions.");}
var StockMessages=dcodeIO.ProtoBuf.loadProtoFile("StockMessages.proto"),Header=StockMessages.build("Header"),HeaderReader=StockMessages.build("HeaderReader"),BarDetails=StockMessages.build("BarDetails"),ChartResponseData=StockMessages.build("ChartResponseData"),ChartRequestData=StockMessages.build("ChartRequestData"),ChartRequest=StockMessages.build("ChartRequest"),ChartResponse=StockMessages.build("ChartResponse"),AvailableScripsResponse=StockMessages.build("AvailableScripsResponse"),AvailableScripsRequest=
StockMessages.build("AvailableScripsRequest"),AvailableScripsResponseData=StockMessages.build("AvailableScripsResponseData"),AvailableScripsRequestData=StockMessages.build("AvailableScripsRequestData"),QuoteSubscriptionRequest=StockMessages.build("QuoteSubscriptionRequest"),QuoteSubscriptionRequestData=StockMessages.build("QuoteSubscriptionRequestData"),QuoteSubscriptionResponse=StockMessages.build("QuoteSubscriptionResponse"),QuoteSubscriptionResponseData=StockMessages.build("QuoteSubscriptionResponseData"),
Socket=function(){function c(d){this.requestMap={};this.eventsMap={};this.wsUri1="ws://traderslab.in:8484/iciciAutomation/websocket";this.websocket1=new WebSocket(this.wsUri1);this.lastConnectTimeout=5E3;this.pendingRequestArray=[];this.flushRequests=function(){if(this.websocket1.readyState==WebSocket.OPEN){var b;try{for(;0!=this.pendingRequestArray.length;)b=this.pendingRequestArray.shift(),this.sendMessage(b)}catch(a){this.pendingRequestArray.push(b),this.lastConnectTimeout*=2,console.log("Connection lost retrying..."+
this.lastConnectTimeout),setTimeout(this.flushRequests.bind(this),this.lastConnectTimeout)}}else this.websocket1.readyState==WebSocket.CONNECTING?(console.log("Waiting for connection to be established..."),setTimeout(this.flushRequests.bind(this),2E3)):this.websocket1.readyState==WebSocket.CLOSED&&(this.websocket1.close(),this.websocket1=new WebSocket(this.wsUri1),this.configureSocket(),this.lastConnectTimeout*=2,console.log("Retrying connection in "+this.lastConnectTimeout),setTimeout(this.flushRequests.bind(this),
this.lastConnectTimeout))};this.sendMessage=function(b){console.log((new Date).getTime()+" Message sent : "+b);isNode?this.websocket1.send(new Buffer(new Uint8Array(b)),{binary:!0,mask:!0}):this.websocket1.send(b)};this.configureSocket=function(){var b=this;this.websocket1.binaryType="arraybuffer";this.websocket1.onmessage=function(a){try{var e=HeaderReader.decode(a.data).header.callBackId;e&&(b.eventsMap[e]?b.eventsMap[e].notify(a.data):(b.requestMap[e].resolve(a.data),delete b.requestMap[e]))}catch(d){console.log(d)}};
this.websocket1.onopen=function(a){b.lastConnectTimeout=5E3;b.flushRequests()};this.websocket1.onclose=function(a){console.log("Websocket connection closed",a)};this.websocket1.onerror=function(a){console.log("Error occured on websocket connection",a)}};this.configureSocket()}c.prototype.processRequest=function(d,b){var a=Q.defer();this.requestMap[d.header.callBackId]=a;b?this.sendMessage(d.toArrayBuffer()):(this.pendingRequestArray.push(d.toArrayBuffer()),this.flushRequests());return a.promise};
c.prototype.subscribeEvents=function(d,b){var a,e=d.header.callBackId;this.eventsMap[e]?a=this.eventsMap[e]:(a=Q.defer(),this.eventsMap[e]=a);b?this.sendMessage(d.toArrayBuffer()):(this.pendingRequestArray.push(d.toArrayBuffer()),this.flushRequests());return a.promise};c.prototype.unSubscribeEvents=function(){};c.prototype.close=function(d){this.websocket1.close(1E3,d||"Client Closed the Browser")};return c}(),DataService=function(){function c(){var d=this;this.subscriptionProgressCreated=!1;this.SOCKET_CALLBACK_ID=
1;if(c._instance)throw Error("Error: Instantiation failed: Use DataService.getInstance() instead of new.");this.socket=new Socket;c._instance=this;isNode||window.addEventListener("beforeunload",function(){console.log("Before unload closing the socket");d.socket.close()})}c.getInstance=function(){null===c._instance&&(c._instance=new c);return c._instance};c.prototype.getNewCallbackId=function(){return"D"+(this.SOCKET_CALLBACK_ID++).toString()};c.prototype.addHeader=function(d,b){var a=new Header;a.messageType=
d;a.handler=b;a.callBackId=this.getNewCallbackId();return a};c.prototype.getChartData=function(d){var b=Q.defer(),a=new ChartRequest;a.header=this.addHeader("ChartRequest","/chart/data");a.chReqData=d;this.socket.processRequest(a,!1).then(function(a){HeaderReader.decode(a);a=ChartResponse.decode(a);a=JSON.parse(JSON.stringify(a)).chResData;b.resolve(a)});return b.promise};c.prototype.getAvailableScrips=function(d){var b=Q.defer(),a=new AvailableScripsRequest;a.header=this.addHeader("AvailableScripsRequest",
"/availableScrips");a.reqData=d;this.socket.processRequest(a,!1).then(function(a){a=AvailableScripsResponse.decode(a);b.resolve(a.resData)});return b.promise};c.prototype.subscribeForScrips=function(d,b){var a=d.exchange+"_"+d.scrip,a=PubSub.getInstance().subscribe(a,b),c=new QuoteSubscriptionRequest,f=this.addHeader("QuoteSubscriptionRequest","/marketWatch/subscribe");f.callBackId="quoteSubscription";c.header=f;c.reqData=d;c=this.socket.subscribeEvents(c,!1);this.subscriptionProgressCreated||c.progress(function(a){a=
QuoteSubscriptionResponse.decode(a).resData.toRaw();var b=a.exchange+"_"+a.scrip;PubSub.getInstance().publish(b,a)});return a};c.prototype.unSubscribeForScrips=function(c,b){var a=PubSub.getInstance().unsubscribe(b),e=new QuoteSubscriptionRequest,f=this.addHeader("QuoteSubscriptionRequest","/marketWatch/subscribe");f.callBackId="quoteSubscription";e.header=f;e.reqData=c;this.socket.subscribeEvents(e,!1);return a};c._instance=null;return c}();
